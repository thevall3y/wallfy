<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wallify Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .dark {
      background-color: #111827;
      color: #f9fafb;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="sticky top-0 z-50 border-b bg-white/95 backdrop-blur shadow-sm">
    <div class="container mx-auto flex h-16 items-center justify-between px-4">
      <div class="flex items-center gap-4">
        <a href="index.html" class="flex items-center">
          <h1 class="text-2xl font-bold tracking-tight">Wallify Admin</h1>
        </a>
        <div class="flex space-x-2">
          <a href="index.html" class="px-3 py-1 text-sm rounded-md hover:bg-gray-100">View Site</a>
          <button id="addNewBtn" class="px-3 py-1 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">Add New</button>
        </div>
      </div>
      <button id="themeToggle" class="p-2 rounded-md hover:bg-gray-100" aria-label="Toggle theme">
        <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Tabs -->
    <div class="border-b mb-6">
      <div class="flex space-x-8">
        <button id="wallpapersTab" class="px-1 py-3 border-b-2 border-blue-600 font-medium text-blue-600">Wallpapers</button>
        <button id="categoriesTab" class="px-1 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700">Categories</button>
        <button id="settingsTab" class="px-1 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700">Settings</button>
      </div>
    </div>

    <!-- Wallpapers Section -->
    <div id="wallpapersSection">
      <!-- Search and Filter -->
      <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
        <div class="flex gap-3">
          <div class="relative">
            <input type="text" id="searchInput" placeholder="Search wallpapers..." class="w-64 pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <svg xmlns="http://www.w3.org/2000/svg" class="absolute left-3 top-3 h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </div>
          <select id="categoryFilter" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="All">All Categories</option>
            <!-- Categories will be dynamically populated -->
          </select>
        </div>
      </div>

      <!-- Wallpaper Form (Hidden by default) -->
      <div id="wallpaperForm" class="mb-8 bg-white shadow-md rounded-lg p-6 hidden">
        <h2 class="text-xl font-bold mb-6">Add New Wallpaper</h2>
        <form id="addWallpaperForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Title</label>
            <input type="text" id="titleInput" class="w-full px-3 py-2 border rounded-lg" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Category</label>
            <select id="categoryInput" class="w-full px-3 py-2 border rounded-lg" required>
              <!-- Categories will be populated by JavaScript -->
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Image</label>
            <div class="flex gap-4 items-start">
              <div class="flex-1">
                <div class="flex items-center mb-2">
                  <div class="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center mr-2">
                    <span class="text-white text-xs font-bold">1</span>
                  </div>
                  <span class="text-sm">Provide an image URL</span>
                </div>
                <input type="text" id="imageUrlInput" class="w-full px-3 py-2 border rounded-lg" placeholder="https://example.com/image.jpg">
              </div>
              <div class="text-gray-500 text-center">OR</div>
              <div class="flex-1">
                <div class="flex items-center mb-2">
                  <div class="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center mr-2">
                    <span class="text-white text-xs font-bold">2</span>
                  </div>
                  <span class="text-sm">Upload a file</span>
                </div>
                <div class="border-dashed border-2 border-gray-300 rounded-lg p-4 text-center" id="uploadArea">
                  <input type="file" id="imageFileInput" class="hidden" accept="image/*">
                  <button type="button" id="uploadButton" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded">
                    Choose image
                  </button>
                  <p class="text-xs text-gray-500 mt-2">JPG, PNG, WebP (max 5MB)</p>
                </div>
              </div>
            </div>
            <div id="imagePreview" class="mt-3 hidden">
              <p class="text-sm mb-1 font-medium">Preview:</p>
              <div class="relative w-full h-40 bg-gray-100 rounded overflow-hidden">
                <img id="previewImage" class="w-full h-full object-contain" src="" alt="Preview">
                <button type="button" id="removeImageBtn" class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Alternative Home Screen URL (Optional)</label>
            <input type="text" id="homescreenUrlInput" class="w-full px-3 py-2 border rounded-lg" placeholder="Leave empty to use same image URL for both">
            <p class="text-xs text-gray-500 mt-1">Provide a different URL optimized for home screen use</p>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Download URL (Google Drive link)</label>
            <input type="text" id="downloadUrlInput" class="w-full px-3 py-2 border rounded-lg" placeholder="https://drive.google.com/uc?export=download&id=YOUR_FILE_ID">
            <p class="text-xs text-gray-500 mt-1">Google Drive sharing link for downloading the wallpaper</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Width (px)</label>
              <input type="number" id="widthInput" class="w-full px-3 py-2 border rounded-lg" value="1080" required>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Height (px)</label>
              <input type="number" id="heightInput" class="w-full px-3 py-2 border rounded-lg" value="1920" required>
            </div>
          </div>
          <div class="pt-4 flex justify-end space-x-3">
            <button type="button" id="cancelButton" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Wallpaper</button>
          </div>
        </form>
      </div>

      <!-- Wallpapers List -->
      <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Downloads</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="wallpapersList">
            <!-- Wallpapers will be inserted here by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Categories Section (Hidden by default) -->
    <div id="categoriesSection" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">Manage Categories</h2>
        <button id="addCategoryBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Category</button>
      </div>

      <!-- Add Category Form (Hidden by default) -->
      <div id="categoryForm" class="mb-8 bg-white shadow-md rounded-lg p-6 hidden">
        <h2 class="text-xl font-bold mb-6">Add New Category</h2>
        <form id="addCategoryForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Category Name</label>
            <input type="text" id="categoryNameInput" class="w-full px-3 py-2 border rounded-lg" required>
          </div>
          <div class="pt-4 flex justify-end space-x-3">
            <button type="button" id="cancelCategoryButton" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Category</button>
          </div>
        </form>
      </div>

      <!-- Categories List -->
      <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category Name</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wallpapers Count</th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="categoriesList">
            <!-- Categories will be inserted here by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Settings Section (Hidden by default) -->
    <div id="settingsSection" class="hidden">
      <h2 class="text-xl font-bold mb-6">Settings</h2>
      <div class="bg-white shadow-md rounded-lg p-6">
        <h3 class="text-lg font-medium mb-4">Debug Options</h3>
        <div class="space-y-4">
          <div>
            <p class="text-sm text-gray-600 mb-2">If the changes in admin panel are not appearing in the main site, try clearing the storage cache:</p>
            <button id="clearStorageBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              Clear Storage Cache
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
      <h3 class="text-lg font-bold mb-4">Delete Wallpaper</h3>
      <p class="mb-6">Are you sure you want to delete this wallpaper? This action cannot be undone.</p>
      <div class="flex justify-end space-x-3">
        <button id="cancelDelete" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
        <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // Wallpaper data - same as in index.html
    let wallpapers = [
      // Nature wallpapers
      {
        id: 'nature-1',
        title: 'Mountain Lake',
        imageUrl: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb',
        category: 'Nature',
        size: { width: 1080, height: 1920 },
        downloads: 128,
      },
      {
        id: 'nature-2',
        title: 'Forest Path',
        imageUrl: 'https://images.unsplash.com/photo-1511497584788-876760111969',
        category: 'Nature',
        size: { width: 1080, height: 1920 },
        downloads: 95,
      },
      {
        id: 'nature-3',
        title: 'Autumn Colors',
        imageUrl: 'https://images.unsplash.com/photo-1507783548227-544c3b8fc065',
        category: 'Nature',
        size: { width: 1080, height: 1920 },
        downloads: 152,
      },
      {
        id: 'nature-4',
        title: 'Coastal Sunset',
        imageUrl: 'https://images.unsplash.com/photo-1518495973542-4542c06a5843',
        category: 'Nature',
        size: { width: 1080, height: 1920 },
        downloads: 114,
      },
      // Abstract wallpapers
      {
        id: 'abstract-1',
        title: 'Color Burst',
        imageUrl: 'https://images.unsplash.com/photo-1541701494587-cb58502866ab',
        category: 'Abstract',
        size: { width: 1080, height: 1920 },
        downloads: 243,
      },
      {
        id: 'abstract-2',
        title: 'Fluid Waves',
        imageUrl: 'https://images.unsplash.com/photo-1550859492-d5da9d8e45f3',
        category: 'Abstract',
        size: { width: 1080, height: 1920 },
        downloads: 187,
      },
      // Space wallpapers
      {
        id: 'space-1',
        title: 'Galaxy Clusters',
        imageUrl: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564',
        category: 'Space',
        size: { width: 1080, height: 1920 },
        downloads: 328,
      },
      // Cars wallpaper
      {
        id: 'cars-1',
        title: 'Dark Car',
        imageUrl: 'https://i.imgur.com/yH4vTTs.jpeg',
        category: 'Cars',
        size: { width: 1080, height: 1920 },
        downloads: 595,
      },
    ];

    // Categories data
    let categories = ['Nature', 'Abstract', 'Animals', 'Space', 'Cars'];

    // DOM elements
    const wallpapersList = document.getElementById('wallpapersList');
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const wallpaperForm = document.getElementById('wallpaperForm');
    const addWallpaperForm = document.getElementById('addWallpaperForm');
    const titleInput = document.getElementById('titleInput');
    const categoryInput = document.getElementById('categoryInput');
    const imageUrlInput = document.getElementById('imageUrlInput');
    const homescreenUrlInput = document.getElementById('homescreenUrlInput');
    const downloadUrlInput = document.getElementById('downloadUrlInput');
    const widthInput = document.getElementById('widthInput');
    const heightInput = document.getElementById('heightInput');
    const addNewBtn = document.getElementById('addNewBtn');
    const cancelButton = document.getElementById('cancelButton');
    const deleteModal = document.getElementById('deleteModal');
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDelete = document.getElementById('confirmDelete');
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = document.getElementById('sunIcon');
    const moonIcon = document.getElementById('moonIcon');

    // Tab elements
    const wallpapersTab = document.getElementById('wallpapersTab');
    const categoriesTab = document.getElementById('categoriesTab');
    const settingsTab = document.getElementById('settingsTab');
    const wallpapersSection = document.getElementById('wallpapersSection');
    const categoriesSection = document.getElementById('categoriesSection');
    const settingsSection = document.getElementById('settingsSection');
    
    // Category elements
    const categoriesList = document.getElementById('categoriesList');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoryForm = document.getElementById('categoryForm');
    const addCategoryForm = document.getElementById('addCategoryForm');
    const categoryNameInput = document.getElementById('categoryNameInput');
    const cancelCategoryButton = document.getElementById('cancelCategoryButton');

    // DOM elements for image upload
    const uploadButton = document.getElementById('uploadButton');
    const imageFileInput = document.getElementById('imageFileInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const removeImageBtn = document.getElementById('removeImageBtn');
    let uploadedImageData = null;

    // Current state
    let currentCategory = 'All';
    let searchTerm = '';
    let wallpaperToDelete = null;
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
    let editingWallpaperId = null;
    let editingCategoryIndex = null;
    let categoryToDelete = null;

    // Initialize download counts from localStorage
    function initializeDownloadCounts() {
      const savedDownloads = localStorage.getItem('wallpaperDownloads');
      if (savedDownloads) {
        const downloadsData = JSON.parse(savedDownloads);
        // Update download counts in wallpapers array
        wallpapers.forEach(wallpaper => {
          if (downloadsData[wallpaper.id] !== undefined) {
            wallpaper.downloads = downloadsData[wallpaper.id];
          }
        });
      }
    }
    
    // Save wallpapers to API
    function saveWallpapers() {
      console.log("Saving wallpapers:", wallpapers.length);
      
      // Save to localStorage first as a backup
      const wallpapersJson = JSON.stringify(wallpapers);
      localStorage.setItem('wallpapers', wallpapersJson);
      
      // Add a timestamp to help with cache busting
      localStorage.setItem('wallpapers_updated', new Date().getTime());
      
      // Also update download counts
      const downloadsData = {};
      wallpapers.forEach(wallpaper => {
        downloadsData[wallpaper.id] = wallpaper.downloads;
      });
      localStorage.setItem('wallpaperDownloads', JSON.stringify(downloadsData));
      
      // Show success notification
      showNotification('Wallpapers saved successfully!', 'green');
      
      // Try to save to API if available
      fetch('/api/wallpapers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ wallpapers }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log("Also saved to API:", data);
        }
      })
      .catch(error => {
        console.log("Could not save to API (this is normal if running locally):", error);
      });
    }

    // Save categories to API
    function saveCategories() {
      // Make sure we're not saving 'All' in the categories list
      const categoriesToSave = categories.filter(cat => cat !== 'All');
      
      console.log("Saving categories:", categoriesToSave.length);
      
      // Save to localStorage first as a backup
      localStorage.setItem('categories', JSON.stringify(categoriesToSave));
      
      // Show success notification
      showNotification('Categories saved successfully!', 'green');
      
      // Try to save to API if available
      fetch('/api/categories', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ categories: categoriesToSave }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log("Also saved to API:", data);
        }
      })
      .catch(error => {
        console.log("Could not save to API (this is normal if running locally):", error);
      });
    }

    // Load wallpapers from storage or API
    function loadWallpapers() {
      console.log("Loading wallpapers");
      
      // Try localStorage first
      const savedWallpapers = localStorage.getItem('wallpapers');
      if (savedWallpapers) {
        try {
          wallpapers = JSON.parse(savedWallpapers);
          console.log("Loaded wallpapers from localStorage:", wallpapers.length);
          showNotification('Wallpapers loaded from storage', 'green');
          initializeDownloadCounts();
          renderWallpapers();
          return;
        } catch (error) {
          console.error("Error parsing wallpapers from localStorage:", error);
        }
      }
      
      // If localStorage failed or is empty, try API
      fetch('/api/wallpapers')
        .then(response => response.json())
        .then(data => {
          if (data.success && Array.isArray(data.wallpapers)) {
            wallpapers = data.wallpapers;
            showNotification('Wallpapers loaded from server', 'green');
          } else {
            console.log("Using default wallpapers");
            showNotification('Using default wallpapers', 'blue');
          }
          initializeDownloadCounts();
          renderWallpapers();
        })
        .catch(error => {
          console.log("Could not load from API, using defaults:", error);
          showNotification('Using default wallpapers', 'blue');
          initializeDownloadCounts();
          renderWallpapers();
        });
    }

    // Load categories from storage or API
    function loadCategories() {
      console.log("Loading categories");
      
      // Try localStorage first
      const savedCategories = localStorage.getItem('categories');
      if (savedCategories) {
        try {
          categories = JSON.parse(savedCategories);
          console.log("Loaded categories from localStorage:", categories.length);
          showNotification('Categories loaded from storage', 'green');
          populateCategoryDropdowns();
          renderCategories();
          return;
        } catch (error) {
          console.error("Error parsing categories from localStorage:", error);
        }
      }
      
      // If localStorage failed or is empty, try API
      fetch('/api/categories')
        .then(response => response.json())
        .then(data => {
          if (data.success && Array.isArray(data.categories)) {
            categories = data.categories;
            showNotification('Categories loaded from server', 'green');
          } else {
            console.log("Using default categories");
            showNotification('Using default categories', 'blue');
          }
          populateCategoryDropdowns();
          renderCategories();
        })
        .catch(error => {
          console.log("Could not load from API, using defaults:", error);
          showNotification('Using default categories', 'blue');
          populateCategoryDropdowns();
          renderCategories();
        });
    }

    // Populate category dropdowns
    function populateCategoryDropdowns() {
      // Clear existing options except "All Categories"
      while (categoryFilter.options.length > 1) {
        categoryFilter.remove(1);
      }
      
      // Clear all options in categoryInput
      categoryInput.innerHTML = '';
      
      // Add categories to both dropdowns
      categories.forEach(category => {
        // Add to filter dropdown
        const filterOption = document.createElement('option');
        filterOption.value = category;
        filterOption.textContent = category;
        categoryFilter.appendChild(filterOption);
        
        // Add to form dropdown
        const formOption = document.createElement('option');
        formOption.value = category;
        formOption.textContent = category;
        categoryInput.appendChild(formOption);
      });
    }

    // Render wallpapers
    function renderWallpapers() {
      wallpapersList.innerHTML = '';
      
      const filteredWallpapers = currentCategory === 'All' ? 
        wallpapers : 
        wallpapers.filter(w => w.category === currentCategory);
      
      const searchResults = searchTerm ? 
        filteredWallpapers.filter(w => 
          w.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
          w.category.toLowerCase().includes(searchTerm.toLowerCase())
        ) : 
        filteredWallpapers;
      
      searchResults.forEach(wallpaper => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
        
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="h-16 w-16 relative rounded overflow-hidden bg-gray-100">
                <img class="h-full w-full object-cover" src="${wallpaper.imageUrl}" alt="${wallpaper.title}">
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm font-medium">${wallpaper.title}</div>
            <div class="text-xs text-gray-500">
              ${wallpaper.homescreenUrl && wallpaper.homescreenUrl !== wallpaper.imageUrl ? 
                '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Has Home Screen URL</span>' : 
                ''}
              ${wallpaper.downloadUrl ? 
                '<span class="inline-flex items-center px-2 py-0.5 ml-1 rounded text-xs font-medium bg-blue-100 text-blue-800">Has Download URL</span>' : 
                ''}
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${wallpaper.category}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${wallpaper.size.width} × ${wallpaper.size.height}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${wallpaper.downloads}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="flex space-x-2">
              <button class="edit-button text-blue-600 hover:text-blue-800" data-id="${wallpaper.id}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
              </button>
              <button class="delete-button text-red-600 hover:text-red-800" data-id="${wallpaper.id}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          </td>
        `;
        
        wallpapersList.appendChild(row);
      });

      // Add click event listeners for edit and delete buttons
      document.querySelectorAll('.edit-button').forEach(button => {
        button.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          editWallpaper(id);
        });
      });

      document.querySelectorAll('.delete-button').forEach(button => {
        button.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          showDeleteModal(id);
        });
      });
    }

    // Render categories list
    function renderCategories() {
      categoriesList.innerHTML = '';
      
      categories.forEach((category, index) => {
        // Count wallpapers in this category
        const count = wallpapers.filter(w => w.category === category).length;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${category}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">${count}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <div class="flex space-x-2">
              <button class="edit-category-button text-blue-600 hover:text-blue-800" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
              </button>
              <button class="delete-category-button text-red-600 hover:text-red-800" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          </td>
        `;
        categoriesList.appendChild(row);
      });

      // Add click event listeners for edit and delete buttons
      document.querySelectorAll('.edit-category-button').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          editCategory(index);
        });
      });

      document.querySelectorAll('.delete-category-button').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          showDeleteCategoryModal(index);
        });
      });
    }

    // Show form for adding a new wallpaper
    function showAddForm() {
      editingWallpaperId = null;
      wallpaperForm.classList.remove('hidden');
      addWallpaperForm.reset();
      document.querySelector('#wallpaperForm h2').textContent = 'Add New Wallpaper';
    }

    // Edit wallpaper
    function editWallpaper(id) {
      const wallpaper = wallpapers.find(w => w.id === id);
      if (wallpaper) {
        editingWallpaperId = id;
        titleInput.value = wallpaper.title;
        
        // Select the correct category in the dropdown
        Array.from(categoryInput.options).forEach(option => {
          if (option.value === wallpaper.category) {
            option.selected = true;
          }
        });
        
        // Set image URL or preview if it's a base64 image
        if (wallpaper.imageUrl.startsWith('data:image')) {
          uploadedImageData = wallpaper.imageUrl;
          previewImage.src = uploadedImageData;
          imagePreview.classList.remove('hidden');
          imageUrlInput.value = '';
        } else {
          imageUrlInput.value = wallpaper.imageUrl;
          resetImageUpload();
        }
        
        // Set homescreen URL if it exists
        homescreenUrlInput.value = wallpaper.homescreenUrl && wallpaper.homescreenUrl !== wallpaper.imageUrl ? 
          wallpaper.homescreenUrl : '';
          
        // Set download URL if it exists
        downloadUrlInput.value = wallpaper.downloadUrl || '';
        
        widthInput.value = wallpaper.size.width;
        heightInput.value = wallpaper.size.height;
        
        document.querySelector('#wallpaperForm h2').textContent = 'Edit Wallpaper';
        wallpaperForm.classList.remove('hidden');
      }
    }

    // Show delete confirmation modal
    function showDeleteModal(id) {
      wallpaperToDelete = id;
      deleteModal.classList.remove('hidden');
    }

    // Hide delete confirmation modal
    function hideDeleteModal() {
      deleteModal.classList.add('hidden');
      wallpaperToDelete = null;
    }

    // Delete wallpaper
    function deleteWallpaper() {
      if (wallpaperToDelete) {
        wallpapers = wallpapers.filter(w => w.id !== wallpaperToDelete);
        saveWallpapers();
        renderWallpapers();
        hideDeleteModal();
      }
    }

    // Show form for adding a new category
    function showAddCategoryForm() {
      editingCategoryIndex = null;
      categoryForm.classList.remove('hidden');
      addCategoryForm.reset();
      document.querySelector('#categoryForm h2').textContent = 'Add New Category';
    }

    // Edit category
    function editCategory(index) {
      if (index >= 0 && index < categories.length) {
        editingCategoryIndex = index;
        categoryNameInput.value = categories[index];
        
        categoryForm.classList.remove('hidden');
        document.querySelector('#categoryForm h2').textContent = 'Edit Category';
      }
    }

    // Show delete category confirmation modal
    function showDeleteCategoryModal(index) {
      categoryToDelete = index;
      deleteModal.classList.remove('hidden');
    }

    // Delete category
    function deleteCategory() {
      if (categoryToDelete !== null && categoryToDelete >= 0 && categoryToDelete < categories.length) {
        const categoryName = categories[categoryToDelete];
        
        // Update wallpapers with this category to "Uncategorized"
        wallpapers.forEach(wallpaper => {
          if (wallpaper.category === categoryName) {
            wallpaper.category = 'Uncategorized';
          }
        });
        
        // Remove the category
        categories.splice(categoryToDelete, 1);
        
        // If "Uncategorized" is not already in the categories list, add it
        if (!categories.includes('Uncategorized')) {
          categories.push('Uncategorized');
        }
        
        saveCategories();
        saveWallpapers();
        renderCategories();
        populateCategoryDropdowns();
        hideDeleteModal();
      }
    }

    // Switch tabs
    function switchToTab(tabName) {
      // Update tab styling
      [wallpapersTab, categoriesTab, settingsTab].forEach(tab => {
        tab.classList.remove('border-blue-600', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
      });
      
      // Hide all sections
      wallpapersSection.classList.add('hidden');
      categoriesSection.classList.add('hidden');
      settingsSection.classList.add('hidden');
      
      // Show selected tab and section
      if (tabName === 'wallpapers') {
        wallpapersTab.classList.remove('border-transparent', 'text-gray-500');
        wallpapersTab.classList.add('border-blue-600', 'text-blue-600');
        wallpapersSection.classList.remove('hidden');
      } else if (tabName === 'categories') {
        categoriesTab.classList.remove('border-transparent', 'text-gray-500');
        categoriesTab.classList.add('border-blue-600', 'text-blue-600');
        categoriesSection.classList.remove('hidden');
        renderCategories();
      } else if (tabName === 'settings') {
        settingsTab.classList.remove('border-transparent', 'text-gray-500');
        settingsTab.classList.add('border-blue-600', 'text-blue-600');
        settingsSection.classList.remove('hidden');
      }
    }

    // Toggle theme
    function applyTheme() {
      if (isDarkMode) {
        document.body.classList.add('dark');
        document.body.classList.remove('bg-gray-50', 'text-gray-900');
        document.body.classList.add('bg-gray-900', 'text-gray-50');
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
      } else {
        document.body.classList.remove('dark');
        document.body.classList.remove('bg-gray-900', 'text-gray-50');
        document.body.classList.add('bg-gray-50', 'text-gray-900');
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
      }
    }

    function toggleTheme() {
      isDarkMode = !isDarkMode;
      localStorage.setItem('darkMode', isDarkMode);
      applyTheme();
    }

    // Generate a unique ID
    function generateId(category) {
      const categoryWallpapers = wallpapers.filter(w => w.category.toLowerCase() === category.toLowerCase());
      const newIndex = categoryWallpapers.length + 1;
      return `${category.toLowerCase()}-${newIndex}`;
    }

    // Add new category
    function addNewCategory(categoryName) {
      // Validate the category name
      categoryName = categoryName.trim();
      if (!categoryName) return false;
      
      // Prevent duplicates (case insensitive)
      if (categories.some(cat => cat.toLowerCase() === categoryName.toLowerCase())) {
        return false;
      }
      
      // Add the category
      categories.push(categoryName);
      saveCategories();
      populateCategoryDropdowns();
      renderCategories();
      return true;
    }

    // Reset the image upload fields
    function resetImageUpload() {
      uploadedImageData = null;
      imageFileInput.value = '';
      imagePreview.classList.add('hidden');
      previewImage.src = '';
    }

    // Show a notification message
    function showNotification(message, color = 'blue') {
      const notification = document.createElement('div');
      notification.className = `fixed bottom-4 right-4 bg-${color}-600 text-white px-4 py-2 rounded-md shadow-lg z-50`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Initialize app
    function init() {
      loadWallpapers();
      loadCategories();
      populateCategoryDropdowns();
      renderWallpapers();
      renderCategories();
      applyTheme();
      
      // Event listeners for search and filter
      searchInput.addEventListener('input', function() {
        searchTerm = this.value;
        renderWallpapers();
      });
      
      categoryFilter.addEventListener('change', function() {
        currentCategory = this.value;
        renderWallpapers();
      });
      
      // Clear storage button
      const clearStorageBtn = document.getElementById('clearStorageBtn');
      if (clearStorageBtn) {
        clearStorageBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to clear the storage cache? This will reset any unsaved changes.')) {
            localStorage.clear();
            alert('Storage cache cleared. The page will now reload.');
            location.reload();
          }
        });
      }
      
      // Tab navigation
      wallpapersTab.addEventListener('click', function(e) {
        e.preventDefault();
        switchToTab('wallpapers');
        return false;
      });
      
      categoriesTab.addEventListener('click', function(e) {
        e.preventDefault();
        switchToTab('categories');
        return false;
      });
      
      settingsTab.addEventListener('click', function(e) {
        e.preventDefault();
        switchToTab('settings');
        return false;
      });
      
      // Event listeners for wallpaper form
      addNewBtn.addEventListener('click', showAddForm);
      cancelButton.addEventListener('click', function() {
        wallpaperForm.classList.add('hidden');
        resetImageUpload();
      });
      
      addWallpaperForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form
        if (!titleInput.value || !categoryInput.value || (!imageUrlInput.value && !uploadedImageData)) {
          alert("Please fill in all required fields. Either provide an image URL or upload an image.");
          return;
        }
        
        // Get the image URL (either from the URL input or the uploaded file)
        const imageUrl = uploadedImageData || imageUrlInput.value;
        // Get the home screen URL (or use the regular image URL if not provided)
        const homescreenUrl = homescreenUrlInput.value.trim() || imageUrl;
        // Get the download URL (Google Drive link)
        const downloadUrl = downloadUrlInput.value.trim();
        
        if (editingWallpaperId) {
          // Update existing wallpaper
          const index = wallpapers.findIndex(w => w.id === editingWallpaperId);
          if (index !== -1) {
            wallpapers[index].title = titleInput.value;
            wallpapers[index].category = categoryInput.value;
            wallpapers[index].imageUrl = imageUrl;
            wallpapers[index].homescreenUrl = homescreenUrl;
            if (downloadUrl) {
              wallpapers[index].downloadUrl = downloadUrl;
            }
            wallpapers[index].size.width = parseInt(widthInput.value);
            wallpapers[index].size.height = parseInt(heightInput.value);
          }
        } else {
          // Add new wallpaper
          const newWallpaper = {
            id: generateId(categoryInput.value),
            title: titleInput.value,
            imageUrl: imageUrl,
            homescreenUrl: homescreenUrl,
            category: categoryInput.value,
            size: {
              width: parseInt(widthInput.value),
              height: parseInt(heightInput.value)
            },
            downloads: 0
          };
          
          // Add download URL if provided
          if (downloadUrl) {
            newWallpaper.downloadUrl = downloadUrl;
          }
          
          wallpapers.push(newWallpaper);
        }
        
        saveWallpapers();
        renderWallpapers();
        wallpaperForm.classList.add('hidden');
        resetImageUpload();
      });
      
      // Image upload handlers
      uploadButton.addEventListener('click', function() {
        imageFileInput.click();
      });
      
      imageFileInput.addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          
          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('File is too large. Maximum allowed size is 5MB.');
            return;
          }
          
          const reader = new FileReader();
          
          reader.onload = function(e) {
            // Store the base64 data URL
            uploadedImageData = e.target.result;
            
            // Show preview
            previewImage.src = uploadedImageData;
            imagePreview.classList.remove('hidden');
            
            // Clear the URL input
            imageUrlInput.value = '';
          };
          
          reader.readAsDataURL(file);
        }
      });
      
      // Remove uploaded image
      removeImageBtn.addEventListener('click', function() {
        resetImageUpload();
      });
      
      // Event listeners for category form
      addCategoryBtn.addEventListener('click', showAddCategoryForm);
      cancelCategoryButton.addEventListener('click', function() {
        categoryForm.classList.add('hidden');
      });
      
      addCategoryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const categoryName = categoryNameInput.value.trim();
        
        if (categoryName) {
          if (editingCategoryIndex !== null) {
            // Update existing category
            const oldCategory = categories[editingCategoryIndex];
            categories[editingCategoryIndex] = categoryName;
            
            // Update all wallpapers with this category
            wallpapers.forEach(wallpaper => {
              if (wallpaper.category === oldCategory) {
                wallpaper.category = categoryName;
              }
            });
          } else {
            // Add new category if it doesn't already exist
            addNewCategory(categoryName);
          }
          
          saveCategories();
          saveWallpapers();
          renderCategories();
          populateCategoryDropdowns();
          categoryForm.classList.add('hidden');
        }
      });
      
      // Event listeners for delete modal
      cancelDelete.addEventListener('click', hideDeleteModal);
      confirmDelete.addEventListener('click', function() {
        if (categoryToDelete !== null) {
          deleteCategory();
        } else if (wallpaperToDelete !== null) {
          deleteWallpaper();
        }
        hideDeleteModal();
      });
      
      // Event listener for theme toggle
      themeToggle.addEventListener('click', toggleTheme);
    }

    // Run the app
    init();
  </script>
</body>
</html> 